<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON 格式化</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Menlo', 'Monaco', 'Courier New', 'monospace'],
                    },
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 222.2 47.4% 11.2%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96.1%;
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96.1%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 222.2 84% 4.9%;
            --radius: 0.5rem;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
        }
    </style>
</head>

<body class="h-screen flex flex-col p-4 box-border overflow-hidden">
    <!-- Component Template -->
    <template id="json-viewer-template">
        <div class="font-mono text-sm leading-6">
            <!-- Primitive -->
            <div v-if="isPrimitive" class="hover:bg-muted/30 px-1 rounded flex">
                <div v-if="keyName" class="mr-1">
                    <span class="text-purple-600 dark:text-purple-400">"{{ keyName }}"</span><span
                        class="text-muted-foreground">:</span>
                </div>
                <div>
                    <span :class="valueClass">{{ formattedValue }}</span><span v-if="!isLast"
                        class="text-muted-foreground">,</span>
                </div>
            </div>

            <!-- Complex (Object/Array) -->
            <div v-else class="group">
                <div class="flex items-center hover:bg-muted/30 px-1 rounded cursor-pointer select-none"
                    @click="toggle">
                    <span
                        class="w-4 h-4 flex items-center justify-center mr-1 text-muted-foreground transition-transform duration-200"
                        :class="{ 'rotate-90': expanded }">
                        <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24"
                            fill="currentColor" stroke="none">
                            <polygon points="5 3 19 12 5 21 5 3" />
                        </svg>
                    </span>

                    <div v-if="keyName" class="mr-1">
                        <span class="text-purple-600 dark:text-purple-400">"{{ keyName }}"</span><span
                            class="text-muted-foreground">:</span>
                    </div>

                    <span class="text-muted-foreground font-bold">{{ isArray ? '[' : '{' }}</span>

                    <span v-if="!expanded" class="text-xs text-muted-foreground mx-2 px-1.5 py-0.5 bg-muted rounded-sm">
                        {{ itemCount }} {{ itemCount === 1 ? 'item' : 'items' }}
                    </span>

                    <span v-if="!expanded" class="text-muted-foreground font-bold">{{ isArray ? ']' : '}' }}</span><span
                        v-if="!expanded && !isLast" class="text-muted-foreground">,</span>
                </div>

                <div v-if="expanded" class="pl-5 border-l border-muted/50 ml-2.5">
                    <json-viewer v-for="(val, key, index) in data" :key="key" :data="val" :key-name="isArray ? '' : key"
                        :is-last="index === itemCount - 1"></json-viewer>
                </div>

                <div v-if="expanded" class="pl-7 hover:bg-muted/30 rounded px-1">
                    <span class="text-muted-foreground font-bold">{{ isArray ? ']' : '}' }}</span><span v-if="!isLast"
                        class="text-muted-foreground">,</span>
                </div>
            </div>
        </div>
    </template>

    <div id="app" class="flex flex-col h-full gap-4">
        <div class="flex justify-between items-center shrink-0">
            <div class="flex gap-2">
                <button @click="formatJSON"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 py-2">
                    格式化 (Tree)
                </button>
                <button @click="minifyJSON"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">
                    压缩 (Text)
                </button>
                <button @click="clear"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2 text-destructive">
                    清空
                </button>
            </div>
            <div class="flex gap-2">
                <span v-if="error" class="text-sm text-destructive flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10" />
                        <line x1="12" x2="12" y1="8" y2="12" />
                        <line x1="12" x2="12.01" y1="16" y2="16" />
                    </svg>
                    {{ error }}
                </span>
                <span v-else-if="successMessage" class="text-sm text-green-600 flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                        <polyline points="22 4 12 14.01 9 11.01" />
                    </svg>
                    {{ successMessage }}
                </span>
            </div>
        </div>

        <div class="flex-1 flex gap-4 min-h-0">
            <div class="flex-1 flex flex-col gap-2">
                <label
                    class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">输入</label>
                <textarea v-model="input"
                    class="flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 flex-1 resize-none"
                    placeholder="在此粘贴 JSON..."></textarea>
            </div>
            <div class="flex-1 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <label
                        class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
                        输出 <span class="text-muted-foreground font-normal ml-1">({{ viewMode === 'tree' ? 'Tree View' :
                            'Text View' }})</span>
                    </label>
                    <div class="flex gap-2">
                        <button v-if="viewMode === 'tree'" @click="expandAll"
                            class="text-xs text-muted-foreground hover:text-foreground">
                            展开所有
                        </button>
                        <button v-if="viewMode === 'tree'" @click="collapseAll"
                            class="text-xs text-muted-foreground hover:text-foreground">
                            折叠所有
                        </button>
                        <div class="w-px h-4 bg-border mx-1"></div>
                        <button @click="copyOutput"
                            class="text-xs text-muted-foreground hover:text-foreground flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
                                <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
                            </svg>
                            复制
                        </button>
                    </div>
                </div>

                <div class="flex-1 rounded-md border border-input bg-muted/30 relative overflow-hidden flex flex-col">
                    <!-- Tree View -->
                    <div v-if="viewMode === 'tree' && jsonData" class="flex-1 overflow-auto p-4">
                        <json-viewer :data="jsonData" :is-last="true"></json-viewer>
                    </div>

                    <!-- Text View -->
                    <textarea v-else readonly v-model="output"
                        class="flex-1 w-full h-full bg-transparent p-3 text-sm font-mono focus:outline-none resize-none"
                        placeholder="结果将显示在这里..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, provide, inject } = Vue;

        // JsonViewer Component
        const JsonViewer = {
            name: 'JsonViewer',
            template: '#json-viewer-template',
            props: {
                data: [Object, Array, String, Number, Boolean, null],
                keyName: String,
                isLast: Boolean
            },
            setup(props) {
                // Global expand/collapse state injection
                const expandSignal = inject('expandSignal', ref(0));
                const collapseSignal = inject('collapseSignal', ref(0));

                const expanded = ref(true);

                // React to global signals
                Vue.watch(expandSignal, () => expanded.value = true);
                Vue.watch(collapseSignal, () => expanded.value = false);

                const isArray = computed(() => Array.isArray(props.data));
                const isPrimitive = computed(() => props.data === null || typeof props.data !== 'object');

                const itemCount = computed(() => {
                    if (isPrimitive.value) return 0;
                    return isArray.value ? props.data.length : Object.keys(props.data).length;
                });

                const formattedValue = computed(() => {
                    if (props.data === null) return 'null';
                    if (typeof props.data === 'string') return `"${props.data}"`;
                    return String(props.data);
                });

                const valueClass = computed(() => {
                    if (props.data === null) return 'text-gray-500 font-bold';
                    if (typeof props.data === 'boolean') return 'text-blue-600 font-bold';
                    if (typeof props.data === 'number') return 'text-orange-600';
                    if (typeof props.data === 'string') return 'text-green-600';
                    return '';
                });

                const toggle = () => {
                    expanded.value = !expanded.value;
                };

                return {
                    expanded,
                    isArray,
                    isPrimitive,
                    itemCount,
                    formattedValue,
                    valueClass,
                    toggle
                };
            }
        };

        createApp({
            components: {
                JsonViewer
            },
            setup() {
                const input = ref('');
                const output = ref(''); // For text mode
                const jsonData = ref(null); // For tree mode
                const viewMode = ref('text'); // 'text' or 'tree'
                const error = ref('');
                const successMessage = ref('');

                // Signals for expand/collapse all
                const expandSignal = ref(0);
                const collapseSignal = ref(0);
                provide('expandSignal', expandSignal);
                provide('collapseSignal', collapseSignal);

                const formatJSON = () => {
                    error.value = '';
                    successMessage.value = '';
                    if (!input.value.trim()) return;

                    try {
                        const parsed = JSON.parse(input.value);
                        jsonData.value = parsed;
                        viewMode.value = 'tree';
                        // Also update output for copy purposes if needed, but tree view uses jsonData
                        output.value = JSON.stringify(parsed, null, 2);
                        successMessage.value = '格式化成功';
                        setTimeout(() => successMessage.value = '', 2000);
                    } catch (e) {
                        error.value = '无效的 JSON: ' + e.message;
                    }
                };

                const minifyJSON = () => {
                    error.value = '';
                    successMessage.value = '';
                    if (!input.value.trim()) return;

                    try {
                        const parsed = JSON.parse(input.value);
                        output.value = JSON.stringify(parsed);
                        viewMode.value = 'text';
                        successMessage.value = '压缩成功';
                        setTimeout(() => successMessage.value = '', 2000);
                    } catch (e) {
                        error.value = '无效的 JSON: ' + e.message;
                    }
                };

                const clear = () => {
                    input.value = '';
                    output.value = '';
                    jsonData.value = null;
                    viewMode.value = 'text';
                    error.value = '';
                    successMessage.value = '';
                };

                const copyOutput = async () => {
                    let textToCopy = '';
                    if (viewMode.value === 'tree' && jsonData.value) {
                        textToCopy = JSON.stringify(jsonData.value, null, 2);
                    } else {
                        textToCopy = output.value;
                    }

                    if (!textToCopy) return;

                    try {
                        await navigator.clipboard.writeText(textToCopy);
                        successMessage.value = '已复制到剪贴板';
                        setTimeout(() => successMessage.value = '', 2000);
                    } catch (err) {
                        error.value = '复制失败';
                    }
                };

                const expandAll = () => {
                    expandSignal.value++;
                };

                const collapseAll = () => {
                    collapseSignal.value++;
                };

                return {
                    input,
                    output,
                    jsonData,
                    viewMode,
                    error,
                    successMessage,
                    formatJSON,
                    minifyJSON,
                    clear,
                    copyOutput,
                    expandAll,
                    collapseAll
                };
            }
        }).mount('#app');
    </script>
</body>

</html>